name: product-catalog-secure-ci

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write   # for OIDC
  security-events: write

env:
  IMAGE_NAME: product-catalog

jobs:

# ------------------------
# 1️⃣ Build + Test
# ------------------------
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.22

      - name: Build
        run: |
          cd src/product-catalog
          go mod download
          go build -o app main.go

      - name: Unit Tests
        run: |
          cd src/product-catalog
          go test ./...

# ------------------------
# 2️⃣ SAST + Dependency Scan
# ------------------------
  security-scan:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      # SAST
      - name: Run CodeQL
        uses: github/codeql-action/analyze@v3

      # Dependency scan
      - name: Dependency Scan
        uses: anchore/scan-action@v3

# ------------------------
# 3️⃣ Build Container
# ------------------------
  docker:
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - uses: actions/checkout@v4

      - name: Build Image
        run: |
          docker build -t $IMAGE_NAME:${{ github.sha }} src/product-catalog

# ------------------------
# 4️⃣ Container Security Scan
# ------------------------
  container-scan:
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - name: Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: product-catalog:${{ github.sha }}
          severity: CRITICAL,HIGH
          exit-code: 1

# ------------------------
# 5️⃣ SBOM + Signing
# ------------------------
  supply-chain:
    runs-on: ubuntu-latest
    needs: container-scan
    steps:
      - name: Generate SBOM
        uses: anchore/sbom-action@v0

      - name: Sign Image (Cosign)
        uses: sigstore/cosign-installer@v3

# ------------------------
# 6️⃣ Push Image (OIDC Login)
# ------------------------
  push:
    runs-on: ubuntu-latest
    needs: supply-chain
    steps:
      - uses: actions/checkout@v4

      # Example: OIDC to cloud registry
      - name: Login to Registry
        run: echo "OIDC login here"

      - name: Push Image
        run: |
          docker tag product-catalog:${{ github.sha }} myrepo/product-catalog:${{ github.sha }}
          docker push myrepo/product-catalog:${{ github.sha }}

# ------------------------
# 7️⃣ GitOps Deployment
# ------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: push
    steps:
      - uses: actions/checkout@v4

      - name: Update manifest
        run: |
          sed -i "s|image:.*|image: myrepo/product-catalog:${{ github.sha }}|" k8s/deploy.yaml

      - name: Commit for GitOps
        run: |
          git config user.email "ci@company.com"
          git config user.name "ci-bot"
          git commit -am "Update image"
          git push
